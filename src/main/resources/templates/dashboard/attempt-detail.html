<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ì…˜ ì§„í–‰ ìƒì„¸</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .info-table th {
            width: 200px;
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .timeline {
            position: relative;
            padding-left: 40px;
            margin-top: 20px;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 25px;
        }
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        .timeline-dot {
            position: absolute;
            left: -34px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px #007bff;
        }
        .timeline-line {
            position: absolute;
            left: -28px;
            top: 14px;
            bottom: -25px;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-time {
            font-weight: 600;
            color: #495057;
            font-family: 'Courier New', monospace;
        }
        .timeline-content {
            background: #fff;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .timeline-event-type {
            font-weight: 600;
            color: #007bff;
        }
        .timeline-page {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .timeline-diff {
            font-size: 0.85rem;
            color: #28a745;
        }
        .timeline-diff.slow {
            color: #dc3545;
            font-weight: bold;
        }
        .timeline-data {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #6c757d;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .slow-warning {
            color: #dc3545;
            font-weight: bold;
        }
        .badge-xlarge {
            font-size: 1rem;
            padding: 0.5em 0.8em;
        }
        .mission-relevant {
            border-left: 4px solid #28a745 !important;
            background-color: #f0f9f4;
        }
        .mission-irrelevant {
            border-left: 4px solid #6c757d !important;
            background-color: #f8f9fa;
        }
        .page-metadata {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 4px;
        }
        .page-metadata span {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a href="/admin/dashboard" class="navbar-brand">ğŸ“Š ë¯¸ì…˜ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</a>
            <span class="navbar-text text-white-50">ìƒì„¸ ë³´ê¸°</span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <a href="/admin/dashboard" class="btn btn-secondary mb-3">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
                <h1>ë¯¸ì…˜ ì§„í–‰ ìƒì„¸</h1>
            </div>
        </div>

        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h5>
                        <table class="table table-borderless info-table">
                            <tr>
                                <th>Attempt ID</th>
                                <td><code th:text="${attempt.attemptId}">attempt_xxx</code></td>
                            </tr>
                            <tr>
                                <th>Session ID</th>
                                <td><code th:text="${attempt.sessionId}">session_xxx</code></td>
                            </tr>
                            <tr>
                                <th>ë¯¸ì…˜ íƒ€ì…</th>
                                <td>
                                    <span th:text="${attempt.missionType}"
                                          th:classappend="${attempt.missionType.name() == 'PORTFOLIO'} ? 'badge bg-primary badge-xlarge' : 'badge bg-success badge-xlarge'">
                                        PORTFOLIO
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>ë¯¸ì…˜ ì´ë¦„</th>
                                <td th:text="${attempt.missionName}">í¬íŠ¸í´ë¦¬ì˜¤ ìƒì„± ë¯¸ì…˜</td>
                            </tr>
                            <tr>
                                <th>ì‹œì‘ ì‹œê°„</th>
                                <td th:text="${#temporals.format(attempt.startTime, 'yyyy-MM-dd HH:mm:ss')}">2025-01-20 10:30:00</td>
                            </tr>
                            <tr>
                                <th>ì¢…ë£Œ ì‹œê°„</th>
                                <td th:text="${attempt.endTime != null} ? ${#temporals.format(attempt.endTime, 'yyyy-MM-dd HH:mm:ss')} : '-'">2025-01-20 10:36:30</td>
                            </tr>
                            <tr>
                                <th>ì´ ì†Œìš” ì‹œê°„</th>
                                <td>
                                    <strong th:text="${attempt.durationFormatted}">6ë¶„ 30ì´ˆ</strong>
                                </td>
                            </tr>
                            <tr>
                                <th>ìµœì¢… ìƒíƒœ</th>
                                <td>
                                    <span th:if="${attempt.status.name() == 'COMPLETED'}" class="badge bg-success badge-xlarge">ì™„ë£Œ</span>
                                    <span th:if="${attempt.status.name() == 'QUITTED'}" class="badge bg-danger badge-xlarge">í¬ê¸°</span>
                                    <span th:if="${attempt.status.name() == 'IN_PROGRESS'}" class="badge bg-warning text-dark badge-xlarge">ì§„í–‰ì¤‘</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‚¬ìš©ì í›„ê¸° (ë³„ë„ ì„¹ì…˜ìœ¼ë¡œ ë¶„ë¦¬) -->
        <div class="row mt-4" th:if="${attempt.rating != null || (attempt.ratingText != null && attempt.ratingText == 'í¬ê¸°')}">
            <div class="col-md-12">
                <!-- ì™„ë£Œí•œ ë¯¸ì…˜ (í‰ì  ìˆìŒ) -->
                <div class="card" style="border-left: 4px solid #ffc107;" th:if="${attempt.rating != null}">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ’¬ ì‚¬ìš©ì í›„ê¸°</h5>

                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span style="font-size: 2rem; color: #ffc107;" th:text="${#strings.repeat('â­', attempt.rating)}">â­â­â­â­â­</span>
                                <span class="ms-3">
                                    <span class="badge bg-warning text-dark" style="font-size: 1.2rem; padding: 0.5em 1em;"
                                          th:text="${attempt.rating} + 'ì '">5ì </span>
                                </span>
                                <span class="ms-2">
                                    <span class="badge bg-secondary" style="font-size: 1rem; padding: 0.5em 0.8em;"
                                          th:text="${attempt.ratingText}">ë§¤ìš° ì‰¬ì›€</span>
                                </span>
                            </div>
                        </div>

                        <div th:if="${attempt.feedback != null && !#strings.isEmpty(attempt.feedback)}">
                            <h6 class="text-muted mb-2">ğŸ“ ìƒì„¸ í”¼ë“œë°±:</h6>
                            <div class="alert alert-light" style="background: #f8f9fa; border-left: 3px solid #007bff; font-size: 1.1rem;">
                                <em th:text="${attempt.feedback}">ë¹„ì¤‘ ì¡°ì •ì´ ì¢‹ì•˜ì–´ìš”</em>
                            </div>
                        </div>

                        <div th:if="${attempt.feedback == null || #strings.isEmpty(attempt.feedback)}">
                            <p class="text-muted fst-italic">ì‚¬ìš©ìê°€ í…ìŠ¤íŠ¸ í”¼ë“œë°±ì„ ë‚¨ê¸°ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

                <!-- í¬ê¸°í•œ ë¯¸ì…˜ (í¬ê¸° ì‚¬ìœ ) -->
                <div class="card" style="border-left: 4px solid #dc3545;" th:if="${attempt.rating == null && attempt.ratingText == 'í¬ê¸°'}">
                    <div class="card-body">
                        <h5 class="card-title">ğŸšª í¬ê¸° ì‚¬ìœ </h5>

                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <span style="font-size: 2rem;">ğŸ˜</span>
                                <span class="ms-3">
                                    <span class="badge bg-danger" style="font-size: 1.2rem; padding: 0.5em 1em;">ë¯¸ì…˜ í¬ê¸°</span>
                                </span>
                            </div>
                        </div>

                        <div th:if="${attempt.feedback != null && !#strings.isEmpty(attempt.feedback)}">
                            <h6 class="text-muted mb-2">ğŸ“ í¬ê¸° ì‚¬ìœ :</h6>
                            <div class="alert alert-light" style="background: #fff5f5; border-left: 3px solid #dc3545; font-size: 1.1rem;">
                                <em th:text="${attempt.feedback}">ë„ˆë¬´ ì–´ë ¤ì›Œì„œ í¬ê¸°í–ˆìŠµë‹ˆë‹¤</em>
                            </div>
                        </div>

                        <div th:if="${attempt.feedback == null || #strings.isEmpty(attempt.feedback)}">
                            <p class="text-muted fst-italic">í¬ê¸° ì‚¬ìœ ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë‹¨ê³„ë³„ ìƒì„¸ (í¬íŠ¸í´ë¦¬ì˜¤ ë¯¸ì…˜ë§Œ) -->
        <div class="row mt-4" th:if="${attempt.missionType.name() == 'PORTFOLIO' && stepDetails != null && !stepDetails.isEmpty()}">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“Š ë‹¨ê³„ë³„ ìƒì„¸ ì •ë³´</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ë‹¨ê³„</th>
                                        <th>ì´ë¦„</th>
                                        <th>ì„ íƒ ê°’</th>
                                        <th>ì†Œìš” ì‹œê°„</th>
                                        <th>ì¶”ê°€ ì •ë³´</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="step : ${stepDetails}">
                                        <td><strong th:text="${step.step}">1</strong></td>
                                        <td th:text="${step.stepName}">risk_type_selection</td>
                                        <td th:text="${step.selectedLabel}">ì¤‘ë¦½í˜•</td>
                                        <td th:text="${step.timeOnStep} + 'ì´ˆ'"
                                            th:classappend="${step.isSlow} ? 'slow-warning' : ''">13.5ì´ˆ</td>
                                        <td th:text="${step.additionalInfo != null} ? ${step.additionalInfo} : '-'">-</td>
                                        <td>
                                            <span class="badge bg-success">âœ“</span>
                                            <span th:if="${step.isSlow}" class="badge bg-warning">âš ï¸ ëŠë¦¼</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸ -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">â±ï¸ ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸</h5>
                        <p class="text-muted">ì´ <strong th:text="${timeline.size()}">0</strong>ê°œì˜ ì´ë²¤íŠ¸</p>

                        <div class="timeline">
                            <div th:each="event, iterStat : ${timeline}" class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-line" th:unless="${iterStat.last}"></div>

                                <div class="timeline-time" th:text="${#temporals.format(event.timestamp, 'HH:mm:ss.SSS')}">10:30:00.000</div>

                                <div class="timeline-content"
                                     th:classappend="${event.isMissionRelevant != null && event.isMissionRelevant} ? 'mission-relevant' : (${event.isMissionRelevant != null && !event.isMissionRelevant} ? 'mission-irrelevant' : '')">
                                    <div>
                                        <span class="timeline-event-type" th:text="${event.eventType}">page_view</span>
                                        <span th:if="${event.page != null}" class="timeline-page" th:text="' (' + ${event.page} + ')'">(/home)</span>

                                        <!-- ë¯¸ì…˜ ê´€ë ¨ ì—¬ë¶€ ë°°ì§€ -->
                                        <span th:if="${event.isMissionRelevant != null && event.isMissionRelevant}"
                                              class="badge bg-success ms-2">âœ… ë¯¸ì…˜ ê´€ë ¨</span>
                                        <span th:if="${event.isMissionRelevant != null && !event.isMissionRelevant}"
                                              class="badge bg-secondary ms-2">âšª ë¯¸ì…˜ ë¬´ê´€</span>

                                        <span th:if="${event.timeDiff != null}"
                                              th:text="' [+' + ${event.timeDiff} + 'ì´ˆ]'"
                                              th:classappend="${event.timeDiff > 30} ? 'timeline-diff slow' : 'timeline-diff'">[+5ì´ˆ]</span>
                                    </div>

                                    <!-- í˜ì´ì§€ ë©”íƒ€ë°ì´í„° (page_view ì´ë²¤íŠ¸ì˜ ê²½ìš°) -->
                                    <div th:if="${event.duration != null || event.scrollDepth != null || event.referrer != null}"
                                         class="page-metadata">
                                        <span th:if="${event.duration != null}"
                                              th:text="'â±ï¸ ì²´ë¥˜: ' + ${#numbers.formatDecimal(event.duration / 1000.0, 1, 2)} + 'ì´ˆ'">
                                            â±ï¸ ì²´ë¥˜: 5.3ì´ˆ
                                        </span>
                                        <span th:if="${event.scrollDepth != null}"
                                              th:text="'ğŸ“Š ìŠ¤í¬ë¡¤: ' + ${event.scrollDepth} + '%'">
                                            ğŸ“Š ìŠ¤í¬ë¡¤: 75%
                                        </span>
                                        <span th:if="${event.referrer != null && !#strings.isEmpty(event.referrer)}"
                                              th:text="'ğŸ”— ì´ì „: ' + ${event.referrer}"
                                              title="ì´ì „ í˜ì´ì§€">
                                            ğŸ”— ì´ì „: /portfolio
                                        </span>
                                    </div>

                                    <div th:if="${event.dataPreview != null}" class="timeline-data" th:text="${event.dataPreview}">
                                        step: 1, stepName: risk_type_selection
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4 mb-5">
            <div class="col-md-12 text-center">
                <a href="/admin/dashboard" class="btn btn-primary btn-lg">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
        </div>

        <div class="row mt-3 mb-5">
            <div class="col-md-12 text-center text-muted">
                <p>Â© 2025 ì¡¸ì—… ì „ì‹œ ì›¹ì•± - ë¯¸ì…˜ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
